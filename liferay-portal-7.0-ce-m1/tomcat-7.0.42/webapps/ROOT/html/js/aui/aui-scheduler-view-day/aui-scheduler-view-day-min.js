YUI.add("aui-scheduler-view-day",function(e,t){var n=e.Lang,r=n.isBoolean,i=n.isFunction,s=n.isNumber,o=n.isObject,u=n.isString,a=e.DataType.DateMath,f=e.WidgetStdMod,l=e.cached(function(){var t=e.config.doc,n=t.createElement("div"),r=t.getElementsByTagName("body")[0],i=.1;return r&&(n.style.cssText="position:absolute;visibility:hidden;overflow:scroll;width:20px;",n.appendChild(t.createElement("p")).style.height="1px",r.insertBefore(n,r.firstChild),i=n.offsetWidth-n.clientWidth,r.removeChild(n)),i},null,.1),c=function(e,t){return function(n){var r=n.all(e);return r.size()>=t?r:null}},h=function(e,t){return Math.round(e/t)*t},p=function(e){return parseFloat(e)||0},d=e.getClassName,v=d("scheduler-view","table","data"),m=d("scheduler-event"),g=d("scheduler-event","disabled"),y=d("scheduler-event","intersecting"),b=d("scheduler-event","proxy"),w=d("scheduler","today"),E=d("scheduler","today","hd"),S=d("scheduler-view","scrollable"),x=d("scheduler-view","coldata"),T=d("scheduler-view","colgrid"),N=d("scheduler-view","day","current","time"),C=d("scheduler-view","grid"),k=d("scheduler-view","grid","container"),L=d("scheduler-view","day","header","col"),A=d("scheduler-view","day","header","day"),O=d("scheduler-view","day","header","day","first"),M=d("scheduler-view","day","header","day","number"),_=d("scheduler-view","day","header","day","weekday"),D=d("scheduler-view","day","header","table"),P=d("scheduler-view","day","header","view","label"),H=d("scheduler-view","icon","grip","horizontal"),B=d("scheduler-view","marker","division"),j=d("scheduler-view","markercell"),F=d("scheduler-view","markers"),I=d("scheduler-view","day","resizer"),q=d("scheduler-view","day","resizer","icon"),R=d("scheduler-view","day","table"),U=d("scheduler-view","day","table","col"),z=d("scheduler-view","day","table","col","shim"),W=d("scheduler-view","day","table","colblank"),X=d("scheduler-view","day","table","colday"),V=d("scheduler-view","day","table","coltime"),$=d("scheduler-view","day","table","time"),J='<div class="'+N+'"></div>',K='<div class="'+I+'">'+'<div class="'+[H,q].join(" ")+'"></div>'+"</div>",Q='<div class="'+j+'">'+'<div class="'+B+'"></div>'+"</div>",G='<span class="'+P+'">{label}</span>',Y='<table cellspacing="0" cellpadding="0" class="'+R+'">'+"<tbody>"+'<tr class="'+T+'" height="1">'+'<td height="0" class="'+[U,W].join(" ")+'"></td>'+'<td class="'+k+'" colspan="1">'+'<div class="'+C+'">'+'<div class="'+F+'"></div>'+"</div>"+"</td>"+"</tr>"+'<tr class="'+x+'">'+'<td class="'+[U,V].join(" ")+'"></td>'+"</tr>"+"</tbody>"+"</table>",Z='<td class="'+[U,X].join(" ")+'" data-colnumber="{colNumber}">'+'<div class="'+z+'">&nbsp;</div>'+"</td>",et='<div class="'+$+'">{hour}</div>',tt='<table cellspacing="0" cellpadding="0" class="'+D+'">'+"<tbody>"+'<tr class="'+L+'"></tr>'+"</tbody>"+"</table>",nt='<th class="'+A+'" data-colnumber="{colNumber}"><a href="#">&nbsp;</a></th>',rt='<span class="'+M+'">%d</span> <span class="'+_+'">%a</span>',it='<td class="'+[A,O].join(" ")+'"></td>',st=e.Component.create({NAME:"scheduler-view-day",ATTRS:{bodyContent:{value:""},currentTimeNode:{valueFn:function(){return e.Node.create(J)}},days:{value:1,validator:s},delegateConfig:{value:{},setter:function(t){var n=this;return e.merge({dragConfig:{useShim:!1},bubbleTargets:n,container:n.get("boundingBox"),nodes:"."+m,invalid:"input, select, button, a, textarea, ."+g},t||{})},validator:o},eventWidth:{value:95,validator:s},filterFn:{value:function(e){return e.getHoursDuration()<=24&&!e.get("allDay")}},headerDateFormatter:{value:function(t){var n=this,r=n.get("scheduler");return e.DataType.Date.format(t,{format:rt,locale:r.get("locale")})},validator:u},headerView:{value:!0,validator:r},headerViewConfig:{setter:function(t){return e.merge({displayDaysInterval:1,displayRows:6,filterFn:function(e){return e.getHoursDuration()>24||e.get("allDay")},height:"auto",visible:!0},t||{})},value:{}},hourHeight:{value:52,validator:s},name:{value:"day"},navigationDateFormatter:{value:function(t){var n=this,r=n.get("scheduler");return e.DataType.Date.format(t,{format:"%A, %B %d, %Y",locale:r.get("locale")})},validator:i},strings:{value:{allDay:"All day"}},headerTableNode:{valueFn:function(){return e.Node.create(tt)}},headerViewLabelNode:{valueFn:function(){var t=this,r=t.get("strings");return e.Node.create(n.sub(G,{label:r.allDay}))}},resizerNode:{valueFn:function(){return e.Node.create(K)}},tableNode:{valueFn:function(){return e.Node.create(Y)}},colDaysNode:{valueFn:"_valueColDaysNode"},colHeaderDaysNode:{valueFn:"_valueColHeaderDaysNode"},markercellsNode:{valueFn:"_valueMarkercellsNode"},timesNode:{valueFn:"_valueTimesNode"}},HTML_PARSER:{colDaysNode:c("."+X,1),colHeaderDaysNode:c("."+A,2),currentTimeNode:"."+N,headerTableNode:"."+D,headerViewLabelNode:"."+P,markercellsNode:c("."+j,24),resizerNode:"."+I,tableNode:"."+R,timesNode:c("."+$,24)},EXTENDS:e.SchedulerView,prototype:{initializer:function(){var t=this;t.colDaysNode=t.get("colDaysNode"),t.colHeaderDaysNode=t.get("colHeaderDaysNode"),t.currentTimeNode=t.get("currentTimeNode"),t.headerTableNode=t.get("headerTableNode"),t.markercellsNode=t.get("markercellsNode"),t.resizerNode=t.get("resizerNode"),t.tableNode=t.get("tableNode"),t.timesNode=t.get("timesNode"),t.activeColumn=null,t.columnData=t.tableNode.one("."+x),t.columnDayHeader=t.headerTableNode.one("."+L),t.columnShims=t.colDaysNode.all("."+z),t.columnTime=t.tableNode.one("."+V),t.gridContainer=t.tableNode.one("."+k),t.markersNode=t.tableNode.one("."+F),t.get("headerView")&&(t.headerView=new e.SchedulerTableView(t.get("headerViewConfig")))},destructor:function(){this._eventHandles&&(new e.EventHandle(this._eventHandles)).detach(),clearInterval(this._currentTimeInterval)},renderUI:function(){var e=this;e.columnTime.setContent(e.timesNode),e.markersNode.setContent(e.markercellsNode),e.colDaysNode.appendTo(e.columnData),e.colHeaderDaysNode.appendTo(e.columnDayHeader),e.headerView&&(e.headerView.set("scheduler",e.get("scheduler")),e.headerView.render
())},bindUI:function(){var t=this;t.headerTableNode.delegate("click",e.bind(t._onClickDaysHeader,t),"."+A),this._bindMouseEvents(),this._bindCurrentTimeInterval(),t.on("drag:end",t._onEventDragEnd),t.on("drag:start",t._onEventDragStart),t.on("drag:tickAlignY",t._dragTickAlignY),t.on("schedulerChange",t._onSchedulerChange),t.after("drag:align",t._afterDragAlign)},syncUI:function(){var e=this;st.superclass.syncUI.apply(this,arguments),e.gridContainer.attr("colspan",e.get("days")),e.syncCurrentTimeUI(),e._setupDragDrop()},syncStdContent:function(){var t=this;t.setStdModContent(f.BODY,t.tableNode.getDOM());var n=e.NodeList.create(t.headerTableNode);t.headerView&&(n.push(t.headerView.get("boundingBox")),n.push(t.get("headerViewLabelNode"))),t.setStdModContent(f.HEADER,n)},calculateEventHeight:function(e){var t=this,n=t.get("hourHeight");return Math.max(e*(n/60),n/2)},calculateTop:function(e){var t=this;return(e.getHours()*60+e.getMinutes()+e.getSeconds()/60)*(t.get("hourHeight")/60)},getNextDate:function(){var e=this,t=e.get("scheduler").get("viewDate");return a.toLastHour(a.add(t,a.DAY,1))},getPrevDate:function(){var e=this,t=e.get("scheduler").get("viewDate");return a.toMidnight(a.subtract(t,a.DAY,1))},getColumnByDate:function(e){var t=this;return t.colDaysNode.item(t.getDateDaysOffset(e))},getColumnShimByDate:function(e){var t=this;return t.columnShims.item(t.getDateDaysOffset(e))},getDateByColumn:function(e){var t=this,n=a.safeClearTime(t.get("scheduler").get("viewDate"));return a.add(n,a.DAY,e)},getDateDaysOffset:function(e){var t=this,n=a.safeClearTime(t.get("scheduler").get("viewDate"));return a.getDayOffset(a.safeClearTime(e),n)},getYCoordTime:function(e){var t=this,n=t.get("hourHeight"),r=p((e/n).toFixed(2)),i=Math.floor(r*100%100*.6),s=Math.floor(r);return[s,i,0]},plotEvent:function(e){var t=this,n=e.get("node");n.size()<2&&e.addPaddingNode();var r=e.get("node").item(0),i=e.get("node").item(1),s=t.getColumnShimByDate(e.get("endDate")),o=t.getColumnShimByDate(e.get("startDate"));o?(o.append(r),e.get("visible")&&r.show()):r.hide(),s?s.compareTo(o)||e.isDayBoundaryEvent()?i.hide():(s.append(i),e.get("visible")&&i.show()):i.hide(),e.syncUI(),t.syncEventTopUI(e),t.syncEventHeightUI(e)},plotEvents:function(){var t=this,n=t.get("scheduler"),r=t.get("filterFn");t.columnShims.each(function(i,s){var o=n.getEventsByDay(t.getDateByColumn(s),!0),u=[];i.empty(),e.Array.each(o,function(e){r.apply(t,[e])&&(t.plotEvent(e),u.push(e))}),t.syncEventsIntersectionUI(u)}),t.syncHeaderViewUI(),t.syncCurrentTimeUI()},scrollToDate:function(e){var t=this.get("boundingBox").one("."+S);this.get("scrollable")&&t&&t.set("scrollTop",this.calculateTop(e))},syncColumnsUI:function(){var e=this,t=e.get("scheduler").get("todayDate");e.colDaysNode.each(function(n,r){var i=e.getDateByColumn(r);n.toggleClass(w,!a.isDayOverlap(i,t))}),this.syncCurrentTimeUI()},syncCurrentTimeUI:function(){var e=this.get("currentTimeNode"),t=this.colDaysNode.get("parentNode").one("."+w);t?(t.one("."+z).append(e),e.setStyle("top",this.calculateTop(new Date)+"px")):e.remove()},syncDaysHeaderUI:function(){var e=this,t=e.get("scheduler").get("viewDate"),n=e.get("headerDateFormatter"),r=e.get("scheduler").get("todayDate");e.colHeaderDaysNode.all("a").each(function(i,s){var o=a.add(t,a.DAY,s);i.toggleClass(E,!a.isDayOverlap(o,r)),i.html(n.call(e,o))})},syncEventsIntersectionUI:function(t){var n=this,r=n.get("eventWidth");n.get("scheduler").flushEvents(),e.Array.each(t,function(i){var s=n.findEventIntersections(i,t),o=s.length,u=r/o;e.Array.each(s,function(e,t){var n=e.get("node").item(0),i=u*t,s=u*1.7;t===o-1&&(s=r-i),n.setStyle("width",s+"%"),n.setStyle("left",i+"%"),o>1?n.addClass(y):n.removeClass(y);var a=n.get("parentNode");a&&a.insert(n,t),e._filtered=!0})})},syncEventHeightUI:function(e){var t=this,n=e.get("endDate"),r=e.get("startDate"),i=a.clone(r);i.setHours(24,0,0);var s=a.getMinutesOffset(t.limitDate(n,i),r);e.get("node").item(0).set("offsetHeight",t.calculateEventHeight(s));var o=e.get("node").item(1);if(o.inDoc()){var u=a.getMinutesOffset(n,a.toMidnight(e.getClearEndDate()));o.set("offsetHeight",t.calculateEventHeight(u))}},syncEventTopUI:function(e){var t=this;e.get("node").item(0).setStyle("top",t.calculateTop(e.get("startDate"))+"px"),e.get("node").item(1).setStyle("top",0)},syncHeaderViewUI:function(){var e=this;if(e.get("headerView")){var t=e.headerView;t.plotEvents(),e.headerNode.setStyle("paddingRight",l());var n=t.get("boundingBox"),r=n.one("."+v),i=Math.max(r.get("offsetHeight"),40);t.set("height",i),e._fillHeight()}},calculateYDelta:function(e,t){var n=this;return(t[1]-e[1])/(n.get("hourHeight")/2)*30},findEventIntersections:function(t,n){var r=[];return e.Array.each(n,function(e){!t._filtered&&e.get("visible")&&t.intersectHours(e)&&r.push(e)}),r},getXYDelta:function(t){var n=t.currentTarget.getXY(),r=[t.pageX,t.pageY];return e.Array.map(n,function(e,t){return r[t]-e})},getTickY:function(){var e=this;return h(Math.ceil(e.get("hourHeight")/2),10)},roundToNearestHour:function(e,t){var n=this;e.setHours(t[0],h(t[1],n.getTickY()),t[2])},_afterDragAlign:function(e){var t=this,n=e.target;t.startXY||(t.startXY=n.actXY),n.actXY[0]=null},_bindMouseEvents:function(){this.columnData.delegate("mousedown",e.bind(this._onMouseDownTableCol,this),"."+U),this.columnData.delegate("mouseenter",e.bind(this._onMouseEnterEvent,this),"."+m),this.columnData.delegate("mouseleave",e.bind(this._onMouseLeaveEvent,this),"."+m),this.columnData.delegate("mousemove",e.bind(this._onMouseMoveTableCol,this),"."+X),this.columnData.delegate("mouseup",e.bind(this._onMouseUpTableCol,this),"."+U)},_afterVisibleChange:function(){clearInterval(this._currentTimeInterval),this.get("visible")&&this._bindCurrentTimeInterval()},_bindCurrentTimeInterval:function(){this._currentTimeInterval=setInterval(e.bind(this.syncCurrentTimeUI,this),6e4)},_dragTickAlignX:function(e){var t=this,n=t.draggingEvent;if(n&&!t.resizing){var r=t.eventPlaceholder,i=p(e.attr("data-colnumber"))-
t.startColNumber;t.draggingEventStartDate=a.add(n.get("startDate"),a.DAY,i);var s=a.clone(t.draggingEventStartDate);a.copyHours(s,r.get("startDate")),r.move(s,{silent:!0}),t.plotEvent(r)}},_dragTickAlignY:function(e){var t=this,n=t.draggingEvent;if(n){var r=e.target.get("host"),i=t.eventPlaceholder,s=t.calculateYDelta(t.startXY,r.actXY);if(t.resizing){var o=a.add(t.draggingEventEndDate,a.MINUTES,s);if(a.getMinutesOffset(o,t.draggingEventStartDate)<30)return;i.set("endDate",o,{silent:!0})}else i.move(a.add(t.draggingEventStartDate,a.MINUTES,s),{silent:!0});t.plotEvent(i)}},_findActiveColumn:function(e){return e.currentTarget},_setupDragDrop:function(){var t=this,n=t.eventPlaceholder;if(!n){var r=t.get("scheduler");n=new r.eventModel({scheduler:r}),n.removeTarget(r),n.get("node").addClass(b),n.set("visible",!1,{silent:!0}),t.eventPlaceholder=n}t.delegate||(t.delegate=new e.DD.Delegate(t.get("delegateConfig")));var i=t.delegate.dd;i.unplug(e.Plugin.DDConstrained),i.unplug(e.Plugin.DDNodeScroll);var s=t.bodyNode.get("region");s.bottom=Infinity,s.top=-Infinity,i.plug(e.Plugin.DDConstrained,{bubbleTargets:t,constrain:s,stickY:!0,tickY:t.get("hourHeight")/2}),i.plug(e.Plugin.DDNodeScroll,{node:t.bodyNode,scrollDelay:150})},_uiSetDate:function(){var e=this;e.syncColumnsUI(),e.syncDaysHeaderUI()},_onClickDaysHeader:function(e){var t=this,n=t.get("scheduler");if(e.target.test("a, a span")){var r=n.getViewByName("day");if(r){var i=p(e.currentTarget.attr("data-colnumber"));n.set("date",t.getDateByColumn(i)),n.set("activeView",r)}}e.preventDefault()},_onEventDragEnd:function(){var e=this,t=e.draggingEvent;if(t){var n=e.eventPlaceholder;n.set("visible",!1,{silent:!0}),t.set("visible",!0,{silent:!0}),t.copyDates(n),e.get("scheduler").syncEventsUI()}e.startXY=null,e.draggingEvent=null},_onEventDragStart:function(){var e=this,t=e.draggingEvent=e.delegate.dd.get("node").getData("scheduler-event");if(t){var n=e.eventPlaceholder;n.copyPropagateAttrValues(t,null,{silent:!0}),e.plotEvent(n),t.set("visible",!1,{silent:!0}),e.draggingEventStartDate=a.clone(t.get("startDate")),e.draggingEventEndDate=a.clone(t.get("endDate"));var r=e.getColumnByDate(t.get("startDate"));e.startColNumber=r?p(r.attr("data-colnumber")):0}},_onMouseDownTableCol:function(e){var t=this,n=e.target,r=t.get("scheduler"),i=r.get("eventRecorder");i&&!r.get("disabled")&&(i.hidePopover(),n.test("."+z)?this._prepareEventCreation(e):n.test(["."+I,"."+q].join(","))&&(t.resizing=!0)),t.get("boundingBox").unselectable()},_onMouseEnterEvent:function(e){var t=this,n=e.currentTarget,r=n.getData("scheduler-event");r&&!r.get("disabled")&&t.resizerNode.appendTo(n)},_onMouseLeaveEvent:function(){var e=this;e.resizing||e._removeResizer()},_onMouseMoveTableCol:function(e){var t=this,n=this._findActiveColumn(e),r=t.get("scheduler").get("eventRecorder");t.activeColumn!==n&&(t.activeColumn=n,t._dragTickAlignX(t.activeColumn));var i=t.creationStartDate;if(i){var s=h(t.calculateYDelta(t.startXY,[e.pageX,e.pageY]),t.getTickY()),o=s>=t._delta;if(t._delta!==s){if(s>0){var u=o?Math.max(s,r.get("duration")):s;r.set("endDate",a.add(i,a.MINUTES,u),{silent:!0})}else r.set("startDate",a.add(i,a.MINUTES,s),{silent:!0});t.plotEvent(r),t._delta=s}}},_onMouseUpTableCol:function(){var e=this,t=e.get("scheduler"),n=t.get("eventRecorder");n&&!t.get("disabled")&&e.creationStartDate&&(e.plotEvent(n),n.showPopover()),e.creationStartDate=null,e.resizing=!1,e.startXY=null,e._removeResizer(),e.get("boundingBox").selectable()},_onSchedulerChange:function(e){var t=this;t.headerView&&t.headerView.set("scheduler",e.newVal)},_prepareEventCreation:function(e,t){var n=this.getXYDelta(e),r=p(e.currentTarget.attr("data-colnumber")),i,s=this.getDateByColumn(r),o=this.get("scheduler").get("eventRecorder");this.startXY=[e.pageX,e.pageY],this.roundToNearestHour(s,this.getYCoordTime(n[1])),t||(t=o.get("duration")),i=a.add(s,a.MINUTES,t),o.move(s,{silent:!0}),o.setAttrs({allDay:!1,endDate:i},{silent:!0}),this.creationStartDate=s,e.halt()},_removeResizer:function(){var e=this;e.resizerNode.remove()},_valueColDaysNode:function(){var t=this,n=t.get("days"),r=[],i=0;while(n--)r.push(e.Lang.sub(Z,{colNumber:i++}));return e.NodeList.create(r.join(""))},_valueColHeaderDaysNode:function(){var t=this,n=t.get("days"),r=[],i=0;r.push(it);while(n--)r.push(e.Lang.sub(nt,{colNumber:i++}));return e.NodeList.create(r.join(""))},_valueMarkercellsNode:function(){var t=[],n;for(n=0;n<=23;n++)t.push(Q);return e.NodeList.create(t.join(""))},_valueTimesNode:function(){var t=this,r=t.get("isoTime"),i=[],s;for(s=0;s<=23;s++)i.push(n.sub(et,{hour:r?a.toIsoTimeString(s):a.toUsTimeString(s,!1,!0)}));return e.NodeList.create(i.join(""))}}});e.SchedulerDayView=st},"3.0.0pr2",{requires:["dd-drag","dd-delegate","dd-drop","dd-constrain","aui-scheduler-view-table"],skinnable:!0});
